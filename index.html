<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üìÅ Documentos</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .path { margin: 8px 0 20px; color: #555; }
    .path a { text-decoration: none; }
    .grid { width: 100%; border-collapse: collapse; }
    .grid th, .grid td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; }
    .grid th { background: #fafafa; font-weight: 600; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: #f1f5f9; }
    .folder { font-weight: 600; }
    .hint { font-size: 12px; color: #666; margin-top: 8px; }
    .header { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .search { margin-left:auto; }
    input[type="search"] { padding: 8px 10px; border:1px solid #ddd; border-radius:8px; min-width:220px; }
    .topbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin: 12px 0 16px; }
    .btn { border:1px solid #ddd; background:#fff; border-radius:8px; padding:8px 10px; cursor:pointer; }
    .btn:hover { background:#f7f7f7; }
    .empty { color:#777; padding:16px 0; }
    @media (max-width:600px){ .search { width:100%; margin-left:0 } }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìÅ Repositorio de Documentos</h1>
    <div class="search">
      <input id="q" type="search" placeholder="Buscar por nombre‚Ä¶" />
    </div>
  </div>
  <div class="path" id="breadcrumbs"></div>
  <div class="topbar">
    <button class="btn" id="upBtn">‚¨ÜÔ∏è Subir un nivel</button>
    <span class="hint">Haz clic en una carpeta para entrar o en un archivo para abrir/descargar.</span>
  </div>

  <table class="grid" id="table">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Tipo</th>
        <th>Tama√±o</th>
        <th>√öltima modificaci√≥n*</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="empty" id="empty" style="display:none">No hay elementos para mostrar.</div>
  <p class="hint">* El campo ‚Äú√öltima modificaci√≥n‚Äù se estima con la historia de commits de cada archivo.</p>

  <script>
    // === CONFIGURA AQU√ç ===
    const OWNER = "cvalle2024";   // <-- tu usuario GitHub
    const REPO  = "Documentos-Normativos-SESAL-HND";      // <-- nombre del repo
    const BRANCH = "main";        // rama principal (main/master)

    // Utilidades
    const params = new URLSearchParams(location.search);
    let currentPath = params.get("path") || "";
    const qInput = document.getElementById("q");
    const tbody = document.getElementById("tbody");
    const emptyEl = document.getElementById("empty");

    function setPath(path) {
      const u = new URL(location.href);
      if (path) u.searchParams.set("path", path); else u.searchParams.delete("path");
      history.replaceState(null, "", u);
      currentPath = path;
    }

    function renderBreadcrumbs() {
      const bc = document.getElementById("breadcrumbs");
      if (!currentPath) { bc.innerHTML = `<strong>Ruta:</strong> /`; return; }
      const parts = currentPath.split("/").filter(Boolean);
      let acc = [];
      const links = [`<a href="?">/</a>`];
      for (const p of parts) {
        acc.push(p);
        links.push(`<a href="?path=${encodeURIComponent(acc.join("/"))}">${p}</a>`);
      }
      bc.innerHTML = `<strong>Ruta:</strong> ` + links.join(" / ");
    }

    function formatSize(bytes) {
      if (bytes == null) return "";
      const units = ["B","KB","MB","GB"];
      let i = 0; let v = bytes;
      while (v >= 1024 && i < units.length-1) { v /= 1024; i++; }
      return `${v.toFixed(v<10?1:0)} ${units[i]}`;
    }

    async function getDir(path) {
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path ? path : ""}?ref=${BRANCH}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("No se pudo cargar el contenido.");
      return res.json(); // array de items
    }

    async function getLastCommitISO(path) {
      // Obtiene la √∫ltima fecha de commit que toc√≥ ese archivo
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/commits?path=${encodeURIComponent(path)}&sha=${BRANCH}&per_page=1`;
      try {
        const res = await fetch(url);
        if (!res.ok) return "";
        const data = await res.json();
        return (data[0] && data[0].commit && data[0].commit.committer && data[0].commit.committer.date) || "";
      } catch { return ""; }
    }

    function rawUrl(path) {
      return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${path}`;
    }

    function goTo(path) {
      setPath(path);
      load();
    }

    async function load() {
      renderBreadcrumbs();
      tbody.innerHTML = `<tr><td colspan="4">Cargando‚Ä¶</td></tr>`;
      emptyEl.style.display = "none";

      try {
        let items = await getDir(currentPath);
        // Filtrar por b√∫squeda
        const needle = (qInput.value || "").toLowerCase().trim();
        if (needle) {
          items = items.filter(it => it.name.toLowerCase().includes(needle));
        }

        // Orden: carpetas primero, luego archivos (alfab√©tico)
        items.sort((a,b) => {
          if (a.type !== b.type) return a.type === "dir" ? -1 : 1;
          return a.name.localeCompare(b.name, "es");
        });

        if (!items.length) {
          tbody.innerHTML = "";
          emptyEl.style.display = "block";
          return;
        }

        tbody.innerHTML = "";
        for (const it of items) {
          const tr = document.createElement("tr");

          // Nombre (link)
          const nameTd = document.createElement("td");
          if (it.type === "dir") {
            const a = document.createElement("a");
            a.textContent = it.name + "/";
            a.href = "javascript:void(0)";
            a.onclick = () => goTo((currentPath ? currentPath + "/" : "") + it.name);
            a.className = "folder";
            nameTd.appendChild(a);
          } else {
            const a = document.createElement("a");
            a.textContent = it.name;
            a.href = rawUrl((currentPath ? currentPath + "/" : "") + it.name);
            a.target = "_blank"; // abrir/ver/descargar
            nameTd.appendChild(a);
          }
          tr.appendChild(nameTd);

          // Tipo
          const typeTd = document.createElement("td");
          typeTd.innerHTML = `<span class="badge">${it.type === "dir" ? "Carpeta" : "Archivo"}</span>`;
          tr.appendChild(typeTd);

          // Tama√±o
          const sizeTd = document.createElement("td");
          sizeTd.textContent = it.type === "file" ? formatSize(it.size) : "";
          tr.appendChild(sizeTd);

          // √öltima modificaci√≥n
          const modTd = document.createElement("td");
          const pathForCommits = (currentPath ? currentPath + "/" : "") + it.name;
          getLastCommitISO(pathForCommits).then(dateISO => {
            modTd.textContent = dateISO ? new Date(dateISO).toLocaleString() : "";
          });
          tr.appendChild(modTd);

          tbody.appendChild(tr);
        }
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4">Error: ${e.message}</td></tr>`;
      }
    }

    document.getElementById("upBtn").onclick = () => {
      if (!currentPath) return;
      const parts = currentPath.split("/").filter(Boolean);
      parts.pop();
      goTo(parts.join("/"));
    };
    qInput.addEventListener("input", () => load());

    load();
  </script>
</body>
</html>

